---
import ThemeToggler from "./theme-toggler.svelte";
---

<nav
  class="fixed items-center flex justify-between w-full z-50 group p-4"
  data-inview="false"
>
  <h1
    class="group-data-[inview='false']:text-4xl font-accent tracking-tighter transition-transform duration-200 ease-linear hover:animate-gelatine-in-out"
  >
    <a href="/" class="text-white" id="nav-title" data-text="Kostur.">Kos<span class="text-accent">tur.</span></a>
  </h1>
  <ThemeToggler client:load />
</nav>

<script>
  // Intersection Observer setup
  const gallerySection = document.querySelector("#gallery")!;
  const navbar = document.querySelector("nav")!;

  const options = {
    threshold: 1.0,
  };

  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      const intersecting = entry.isIntersecting;

      navbar.setAttribute("data-inview", JSON.stringify(intersecting));
    }, options);
  });

  observer.observe(gallerySection);

  // Text scramble effect on nav title
  const navTitle = document.getElementById("nav-title");
  if (navTitle) {
    const finalText = navTitle.dataset.text ?? "Kostur.";
    const accentStart = 3; // "tur." starts at index 3
    const chars = "!@#$%&*?/\\|<>{}[]~^";
    const duration = 800;  // total ms
    const steps = 12;
    let step = 0;

    function scrambleStep() {
      if (step >= steps) {
        // Restore original HTML
        navTitle!.innerHTML = `Kos<span class="text-accent">tur.</span>`;
        return;
      }

      const progress = step / steps;
      let result = "";
      for (let i = 0; i < finalText.length; i++) {
        if (i / finalText.length < progress) {
          // Revealed character
          const ch = finalText[i];
          if (i >= accentStart) {
            result += `<span class="text-accent">${ch}</span>`;
          } else {
            result += ch;
          }
        } else {
          // Random character
          const ch = chars[Math.floor(Math.random() * chars.length)];
          if (i >= accentStart) {
            result += `<span class="text-accent">${ch}</span>`;
          } else {
            result += ch;
          }
        }
      }
      navTitle!.innerHTML = result;
      step++;
      setTimeout(scrambleStep, duration / steps);
    }

    // Also scramble on hover
    navTitle.addEventListener("mouseenter", () => {
      step = 0;
      scrambleStep();
    });

    // Initial scramble on page load
    scrambleStep();
  }
</script>

<style>
  [data-inview="true"] {
    @apply backdrop-blur-3xl bg-black bg-opacity-60;
  }

  [data-inview="true"] > h1 {
    @apply transform scale-110 text-4xl transition-transform duration-300 ease-linear;
  }
</style>
